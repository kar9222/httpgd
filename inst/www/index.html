<html lang="en">

<head>
  <meta charset="utf-8">
  <title>R Plot</title>

  <link rel="icon" type="image/svg" sizes="32x32" href="/favicon-32x32.svg">
  <link rel="icon" type="image/svg" sizes="16x16" href="/favicon-16x16.svg">
  <link href="./style.css" rel="stylesheet">
  <script src="./httpgd.js"></script>
</head>

<body>
  <div id="container">
    <div id="overlay">
      <div id="overlay-text"></div>
    </div>
    <div id="gallery-container">
    </div>
    <div class="plotview" id="plotview">
      <div id="toolbar">
        <div id="tb-tools">
          <span>
            <a title="Previous (&larr;)" id="tb-left" class="tooltip"><svg class="icon" height="24" viewBox="0 0 24 24"
                width="24">
                <path d="M0 0h24v24H0z" fill="none" />
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
              </svg><span class="tooltiptext">Previous (&larr;)</span></a>
            <a title="Newest (N)" id="tb-pnum" class="tooltip">0/0<span class="tooltiptext">Newest (N)</span></a>
            <a title="Next (&rarr;)" id="tb-right" class="tooltip"><svg class="icon" height="24" viewBox="0 0 24 24"
                width="24">
                <path d="M0 0h24v24H0z" fill="none" />
                <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z" />
              </svg><span class="tooltiptext">Next (&rarr;)</span></a>
            <!--
        -->
          </span>
          <span>
            <a title="Zoom out (-)" id="tb-minus" class="tooltip"><svg class="icon" height="24" viewBox="0 0 24 24"
                width="24">
                <path d="M0 0h24v24H0V0z" fill="none" />
                <path
                  d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z" />
              </svg><span class="tooltiptext">Zoom out (-)</span></a>
            <a title="Reset zoom (0)" id="tb-zlvl" class="tooltip">100%<span class="tooltiptext">Reset zoom
                (0)</span></a>
            <a title="Zoom in (+)" id="tb-plus" class="tooltip"><svg class="icon" height="24" viewBox="0 0 24 24"
                width="24">
                <path d="M0 0h24v24H0V0z" fill="none" />
                <path
                  d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                <path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z" />
              </svg><span class="tooltiptext">Zoom in (+)</span></a>
            <!--
        -->
          </span>
          <span>
            <a title="Delete (D)" id="tb-remove" class="tooltip"><svg class="icon-warn" height="24" viewBox="0 0 24 24"
                width="24">
                <path d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
              </svg><span class="tooltiptext">Delete (D)</span></a>
            <!--
        -->
          </span>
          <span class="drop">
            <a title="More" id="tb-more"><svg class="icon" height="24" viewBox="0 0 24 24" fill="black" width="24">
                <path d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
              </svg></a>
            <ul>
              <li><a title="Download SVG (S)" id="tb-save-svg"><svg height="24" viewBox="0 0 24 24" width="24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path
                      d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z" />
                  </svg><span>Download SVG</span><span class="drop-kbd">S</span></a></li>
              <li><a title="Download PNG (P)" id="tb-save-png"><svg height="24" viewBox="0 0 24 24" width="24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path
                      d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z" />
                  </svg><span>Download PNG</span><span class="drop-kbd">P</span></a></li>
              <li><a title="Copy PNG (C)" id="tb-copy-png"><svg height="24" viewBox="0 0 24 24" width="24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path
                      d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                  </svg><span>Copy PNG</span><span class="drop-kbd">C</span></a></li>
              <li><a id="tb-clear" class="warn-hover"><svg height="24" viewBox="0 0 24 24" width="24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path d="M0 0h24v24H0V0z" fill="none" />
                    <path
                      d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z" />
                  </svg><span>Clear all plots</span><span class="drop-kbd">Alt+D</span></a></li>
              <li><a id="tb-history"><svg height="24" viewBox="0 0 24 24">
                    <path d="M3,15H21V13H3V15M3,19H21V17H3V19M3,11H21V9H3V11M3,5V7H21V5H3Z" />
                  </svg><span>Show history</span><span class="drop-kbd">H</span></a></li>
            </ul>
            <!--
        -->
          </span>
        </div>
      </div>
      <img id="drawing" crossorigin="anonymous"></img>
    </div>
    <div class="history" id="sidebar"></div>
  </div>
  <script>
    const sparams = new URL(window.location.href).searchParams;

    if (sparams.has("sidebar") && sparams.get("sidebar")) {
        document.getElementById("sidebar").classList.add('notransition');
        document.getElementById("plotview").classList.add('notransition');
        document.getElementById("sidebar").classList.add('nohist');
        document.getElementById("plotview").classList.add('nohist');
        setTimeout(() => {
          document.getElementById("sidebar").classList.remove('notransition');
          document.getElementById("plotview").classList.remove('notransition');
        },300);
      }

    var httpgdViewer = new HttpgdViewer(
      sparams.has("host") ? sparams.get("host") : window.location.host,
      sparams.has("token") ? sparams.get("token") : null,
      sparams.has("ws") ? (sparams.get("ws") != "0") : true
    );

    window.onload = function () {

      const dropElem = document.getElementById("tb-more").parentElement;
      dropElem.onmouseenter = () => {
        dropElem.classList.add('drop-open');
      };
      dropElem.onmouseleave = () => {
        dropElem.classList.remove('drop-open');
      };
      function closeDropdown() {
        dropElem.classList.remove('drop-open');
      }

      httpgdViewer.onZoomStringChange = (s) => {
        document.getElementById("tb-zlvl").childNodes[0].nodeValue = s;
      }
      httpgdViewer.onIndexStringChange = (s) => {
        document.getElementById("tb-pnum").childNodes[0].nodeValue = s;
      }
      httpgdViewer.onDisconnectedChange = (d) => {
        document.getElementById("overlay-text").innerText = "Connection lost.";
        document.getElementById("overlay").style.display = d ? "inline" : "none";
      }
      var httpgd_inactive_delayed;
      httpgdViewer.onDeviceActiveChange = (d) => {
        if (!d) {
          clearTimeout(httpgd_inactive_delayed);
          document.getElementById("overlay").style.display = "none";
        }
        else {
          httpgd_inactive_delayed = setTimeout(() => {
            document.getElementById("overlay-text").innerText = "Device inactive.";
            document.getElementById("overlay").style.display = "inline";
          }, 1000);
        }
      }
      window.addEventListener('resize', () => httpgdViewer.resize());

      httpgdViewer.init(document.getElementById("drawing"), document.getElementById("sidebar"));

      document.getElementById("tb-left").onclick = () => httpgdViewer.navPrevious();
      document.getElementById("tb-right").onclick = () => httpgdViewer.navNext();
      document.getElementById("tb-pnum").onclick = () => httpgdViewer.navNewest();
      document.getElementById("tb-save-svg").onclick = () => {
        httpgdViewer.downloadPlotSVG(document.getElementById("drawing"));
        closeDropdown();
      }
      document.getElementById("tb-save-png").onclick = () => {
        httpgdViewer.downloadPlotPNG(document.getElementById("drawing"));
        closeDropdown();
      };
      document.getElementById("tb-copy-png").onclick = () => {
        httpgdViewer.copyPlotPNG(document.getElementById("drawing"));
        closeDropdown();
      };
      document.getElementById("tb-plus").onclick = () => httpgdViewer.zoomIn();
      document.getElementById("tb-minus").onclick = () => httpgdViewer.zoomOut();
      document.getElementById("tb-zlvl").onclick = () => httpgdViewer.zoomReset();
      document.getElementById("tb-clear").onclick = () => {
        httpgdViewer.navClear();
        closeDropdown();
      };
      document.getElementById("tb-remove").onclick = () => httpgdViewer.navRemove();


      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle('nohist')
        document.getElementById("plotview").classList.toggle('nohist')
        setTimeout(() => httpgdViewer.checkResize(), 300);
        closeDropdown();
      }

      const elem_his = document.getElementById("tb-history");
      document.getElementById("tb-history").onclick = () => toggleSidebar();

      // Javascript keycode e.g. keycode for 'a' is 65. See [Keycode](https://keycode.info/). Example:
      // {
      //   altKey: true,  // Use alt key. Simply remove it if alt key isn't needed
      //   keys: [68],    // The key alone is `d`. Combined key is m-d
      //   fun: () => httpgdViewer.navClear()
      // },
      const shortcuts = [
        {
          keys: [37, 40, 75],  // left, down, k
          fun: () => httpgdViewer.navPrevious()
        },
        {
          keys: [39, 38, 74],  // right, up, j
          fun: () => httpgdViewer.navNext()
        },
        {
          keys: [78],  // n
          fun: () => httpgdViewer.navNewest()
        },
        {
          keys: [187],  // =
          fun: () => httpgdViewer.zoomIn()
        },
        {
          keys: [189],  // -
          fun: () => httpgdViewer.zoomOut()
        },
        {
          altKey: true, keys: [89],  // m-x but AHKREMAP to c-d due to c-d is already mapped for browser
          fun: () => httpgdViewer.navClear()
        },
        {
          keys: [46, 68],  // delete, d
          fun: () => httpgdViewer.navRemove()
        },
        {
          keys: [83],  // s
          fun: () => httpgdViewer.downloadPlotSVG(document.getElementById("drawing"))
        },
        {
          keys: [80],  // p
          fun: () => httpgdViewer.downloadPlotPNG(document.getElementById("drawing"))
        },
        {
          keys: [48],  // 0
          fun: () => httpgdViewer.zoomReset()
        },
        {
          keys: [67],  // c
          fun: () => httpgdViewer.copyPlotPNG(document.getElementById("drawing"))
        },
        {
          keys: [72],  // h
          fun: () => toggleSidebar()
        }
      ];

      window.addEventListener('keydown', (e) => {
        for (let action of shortcuts) {
          for (let keyCode of action.keys) {
            if (keyCode == e.keyCode) {
              if (!action.altKey || e.altKey) {
                action.fun();
                e.preventDefault();
                return;
              }
            }
          }
        }
      });


      const elem_tbt = document.getElementById("toolbar");
      const elem_cnt = document.getElementById("container");
      const TB_FADE_TIMEOUT = 4000;

      var httpgd_tb_fade = setTimeout(() => elem_tbt.classList.add("fade-out"), TB_FADE_TIMEOUT);
      elem_cnt.onmousemove = function () {
        elem_tbt.classList.remove("fade-out");
        clearTimeout(httpgd_tb_fade);
        httpgd_tb_fade = setTimeout(() => elem_tbt.classList.add("fade-out"), TB_FADE_TIMEOUT);
      }
      elem_cnt.onmouseleave = function (mouseEvent) {
        elem_tbt.classList.add("fade-out");
      }
    }
  </script>
</body>

</html>
